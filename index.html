<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø­ÙˆÙ‘Ù„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 flex flex-col items-center">

  <!-- ğŸ¤ ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div class="w-full max-w-3xl bg-gray-800 rounded-lg p-4 space-y-4 shadow-lg">
    <div class="flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸ¤ Ù…ÙØ­ÙˆÙ‘Ù„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ</h1>
      <div class="text-sm text-gray-400" id="timer">Ø§Ù„Ù…Ø¯Ø©: 0 Ø«Ø§Ù†ÙŠØ©</div>
    </div>

    <textarea id="transcript" rows="6"
      class="w-full bg-gray-900 text-white p-3 rounded-lg resize-none border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
      placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Øµ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§..."></textarea>

    <div class="flex flex-wrap gap-3">
      <button id="startBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">ğŸ™ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <button id="pauseBtn" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
      <button id="resumeBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
      <button id="stopBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
  </div>

  <!-- ğŸ—‚ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
  <div class="w-full max-w-3xl mt-6 space-y-2" id="archive"></div>

  <script>
    let recognition;
    let collectedTranscript = "";
    let finalTranscript = "";
    let timer;
    let seconds = 0;
    const timerEl = document.getElementById("timer");
    const transcriptEl = document.getElementById("transcript");
    const archiveEl = document.getElementById("archive");
    let records = JSON.parse(localStorage.getItem("records") || "[]");

    function startTimer() {
      timer = setInterval(() => {
        seconds++;
        timerEl.textContent = `Ø§Ù„Ù…Ø¯Ø©: ${seconds} Ø«Ø§Ù†ÙŠØ©`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timer);
    }

    function renderArchive() {
      archiveEl.innerHTML = "";
      records.forEach((text, index) => {
        const i = records.length - index;
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-3 rounded-lg flex justify-between items-center gap-2";
        div.innerHTML = `
          <span class="flex-1 cursor-pointer hover:underline" onclick="editText(${index})">${text}</span>
          <div class="flex items-center gap-2">
            <button onclick="downloadText(${index})" class="text-green-400">ğŸ“¥</button>
            <button onclick="deleteText(${index})" class="text-red-400">ğŸ—‘ï¸</button>
            <span class="text-xs text-gray-400">${i}</span>
          </div>`;
        archiveEl.appendChild(div);
      });
    }

    function saveToArchive(text) {
      records.unshift(text);
      localStorage.setItem("records", JSON.stringify(records));
      renderArchive();
    }

    function setupSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ÙŠÙØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Chrome Ø£Ùˆ Edge.");
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "ar-SA";
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = (event) => {
        let interimTranscript = "";

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const transcript = event.results[i][0].transcript.trim();

          // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
          if (!collectedTranscript.trim().endsWith(transcript)) {
            collectedTranscript += transcript + " ";
          } else {
            console.log("ØªÙ… ØªØ¬Ø§Ù‡Ù„ ØªÙƒØ±Ø§Ø±:", transcript);
          }
        }

        finalTranscript = collectedTranscript.trim();
        transcriptEl.value = finalTranscript + interimTranscript;
      };

      recognition.onerror = (event) => {
        console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:", event.error);
      };
    }

    document.getElementById("startBtn").addEventListener("click", () => {
      collectedTranscript = "";
      finalTranscript = "";
      transcriptEl.value = "";
      seconds = 0;
      timerEl.textContent = "Ø§Ù„Ù…Ø¯Ø©: 0 Ø«Ø§Ù†ÙŠØ©";
      setupSpeechRecognition();
      recognition.start();
      startTimer();
    });

    document.getElementById("pauseBtn").addEventListener("click", () => {
      if (recognition) {
        recognition.stop();
        stopTimer();
      }
    });

    document.getElementById("resumeBtn").addEventListener("click", () => {
      if (recognition) {
        setupSpeechRecognition();
        recognition.start();
        startTimer();
      }
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      if (recognition) {
        recognition.stop();
        stopTimer();
        const finalText = finalTranscript.trim();
        if (finalText) {
          transcriptEl.value = finalText;
          saveToArchive(finalText);
          collectedTranscript = "";
        }
      }
    });

    window.editText = function(index) {
      const newText = prompt("Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù†Øµ:", records[index]);
      if (newText !== null) {
        records[index] = newText;
        localStorage.setItem("records", JSON.stringify(records));
        renderArchive();
      }
    };

    window.downloadText = function(index) {
      const blob = new Blob([`\uFEFF${records[index]}`], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ØªØ³Ø¬ÙŠÙ„_${index + 1}.txt`;
      a.click();
    };

    window.deleteText = function(index) {
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ")) {
        records.splice(index, 1);
        localStorage.setItem("records", JSON.stringify(records));
        renderArchive();
      }
    };

    renderArchive();
  </script>
</body>
</html>