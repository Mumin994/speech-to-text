<script>
  let recognition;
  let isRecording = false;
  let finalTranscript = '';
  let lastPhrase = '';
  let timerInterval;
  let seconds = 0;

  function startTimer() {
    seconds = 0;
    document.getElementById('timer').innerText = seconds;
    timerInterval = setInterval(() => {
      seconds++;
      document.getElementById('timer').innerText = seconds;
    }, 1000);
  }

  function stopTimer() {
    clearInterval(timerInterval);
  }

  function startRecording() {
    if (!('webkitSpeechRecognition' in window)) {
      alert('متصفحك لا يدعم تحويل الصوت إلى نص');
      return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onresult = function (event) {
      let interimTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        let transcript = event.results[i][0].transcript.trim();
        if (!event.results[i].isFinal) {
          interimTranscript += transcript + ' ';
        } else {
          // فلترة التكرار الدقيقة:
          if (!lastPhrase || transcript !== lastPhrase) {
            finalTranscript += transcript + ' ';
            lastPhrase = transcript;
          }
        }
      }
      document.getElementById('output').value = finalTranscript + interimTranscript;
    };

    recognition.onerror = function (event) {
      console.error('حدث خطأ:', event);
    };

    recognition.start();
    isRecording = true;
    startTimer();
  }

  function pauseRecording() {
    if (recognition && isRecording) {
      recognition.stop();
      isRecording = false;
      stopTimer();
    }
  }

  function resumeRecording() {
    if (!isRecording) {
      startRecording();
    }
  }

  function stopRecording() {
    if (recognition) {
      recognition.stop();
      isRecording = false;
      stopTimer();
      saveToArchive(finalTranscript.trim());
      finalTranscript = '';
      lastPhrase = '';
      document.getElementById('output').value = '';
    }
  }

  function saveToArchive(text) {
    if (!text) return;
    const archive = document.getElementById('archive');
    const item = document.createElement('div');
    item.className = 'archive-item';
    const id = archive.children.length + 1;
    item.innerHTML = `${text} <br><small>#${id}</small>`;
    archive.prepend(item);
  }
</script>